# Сервис построения распределений внутри кластеров

## 1. Описание

Сервис строит "боксплоты" распределений для заданного признака внутри групп субъектов РФ. Результат оформляется как рисунок в формате .png. Четыре группы (кластера) регионов определены на основе ML-модели кластеризации: бедные регионы (кластер 0), средние регионы (кластер 1), регионы "комфорт" (кластер 2), бизнес-регионы (кластер 3). Подробное описание кластеров - в разделе 3 Проекта (p3_analysis.ipynb).

Сервис организован на основе клиент-серверной архитектуры и использует веб-сервер uWSGI либо связку uWSGI + NGINX, последняя также может быть реализована в виде Docker-контейнера.

## 2. Запуск сервера (Debian, Ubuntu)

### Установка uWSGI

\$ sudo apt-get install build-essential python-dev  
\$ pip install uwsgi

### Запуск сервера uWSGI

\$ uwsgi --ini uwsgi_config.ini

Текущая конфигурация запускает локальный сервер на http://localhost:5000

### Запуск сервера через uWSGI + NGINX (опционально):
- установить NGINX: \$ sudo apt install nginx
- настроить NGINX на работу с сокетом /tmp/socket.sock
- запустить uWSGI: \$ uwsgi --ini uwsgi_nginx_config.ini
- запустить NGINX: \$ sudo systemctl restart nginx

### Запуск сервера uWSGI + NGINX через Docker (опционально):
- установить Docker
- собрать образ: docker build -t dplot_server .
- запустить образ: docker run -it --rm -v $PWD/logs:/app/logs --name dplot -p 80:80 dplot_server  
Здесь $PWD/logs - директория для записи файла с результатом

Готовый образ на Docker: dkudr/dplot_server:latest

## 3. Запуск клиента

\$ python3 dplot_client.py 'file.csv' 'region' 'feature' port
* file.csv - csv-файл
* region  - название столбца с названиями регионов
* feature - название столбца с выбранным признаком
* port - номер порта (5000 для сервера uWSGI, 80 для всех остальных вариантов)

Пример:  
\$ python3 dplot_client.py './data/russia_regions_2020.csv' 'region' 'per capita' 5000  
Здесь 'region' - название столбца, содержащего названия регионов, 'per capita' - название столбца с числовым признаком, 5000 - номер порта (может быть 5000 или 80).

После обработки сервером результат записывается в файл ./logs/distributions.png (обновляется при каждом запуске клиента).

## 4. Общие замечания

Сервер самостоятельно стандартизирует названия регионов с помощью регулярных выражений, поэтому они могут быть заданы в достаточно произвольном виде и даже содержать записи, не относящиеся к федеральным субъектам (например федеральные округа) - такие записи не будут учитываться при построении графика. Однако не следует допускать в csv-файле дублирования названий или включения в список названий, которые программа может ошибочно интерпретировать как федеральный субъект (например "администрация московского района" будет интерпретирована как Московская область).

Отсутствующие или нечисловые значения в столбце признака будут проигнорированы (заменены на NaN).

## 5. Файлы

* data/ - служебные файлы: метки кластеров согласно ML-модели, стандартизированные имена субъектов РФ, пример csv-файла (russia_regions_2020.csv)
* logs/ - содержит png-рисунок с результатом
* Dockerfile - файл для сборки Docker-образа
* dplot_client.py - клиент
* dplot_server.py - сервер
* requirements.txt - зависимости
* uwsgi_config.ini - конфигурационный файл uWSGI
* uwsgi_docker_config.ini - конфигурационный файл uWSGI для Docker-образа
* uwsgi_nginx_config.ini - конфигурационный файл связки uWSGI + NGINX